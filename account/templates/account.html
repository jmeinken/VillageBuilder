{% extends "home_base.html" %}
{% load app_filters %}
{% load widget_tweaks %}

{% block subcontent %}

<script type="text/javascript">
	$(document).ready(function(){
		
		$('#name-edit-btn, #name-close-btn').click(function() {
			$('#name-view').toggle();
			$('#name-edit').toggle();
			return false;
		});
		$('#email-edit-btn, #email-close-btn').click(function() {
			$('#email-view').toggle();
			$('#email-edit').toggle();
			return false;
		});
		$('#password-edit-btn, #password-close-btn').click(function() {
			$('#password-view').toggle();
			$('#password-edit').toggle();
			return false;
		});
		$('#privacy-edit-btn, #privacy-close-btn').click(function() {
			$('#privacy-view').toggle();
			$('#privacy-edit').toggle();
			return false;
		});
		$('#phone-edit-btn, #phone-close-btn').click(function() {
			$('#phone-view').toggle();
			$('#phone-edit').toggle();
			return false;
		});
		$('#display-address-edit-btn, #display-address-close-btn').click(function() {
			$('#display-address-view').toggle();
			$('#display-address-edit').toggle();
			return false;
		});
		$('#account-status-edit-btn, #account-status-close-btn').click(function() {
			$('#account-status-view').toggle();
			$('#account-status-edit').toggle();
			return false;
		}); 
		
	}); 
</script>

<script type="text/javascript">
	$(document).ready(function(){
		
		$('#geocode-results-container').hide();
		
		//initialize page
		var mapOptions = {
           center: { lat: 39.83, lng: -98.58},
           zoom: 4
       	};
	    var mymap = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
	    var geocoder = new google.maps.Geocoder();
	    var geocodeResults = [];
	    
	    //google maps will not diplay in modal unless resize event is triggered
	    $("#full-address-modal").on("shown.bs.modal", function(e) {
	        google.maps.event.trigger(mymap, "resize");
	        mymap.setZoom(mapOptions.zoom);
	        mymap.setCenter(mapOptions.center);
	    });
	    
	    //EVENTS/////////////////////////////////////////////////////////
	    
	    //when a different result is selected, update map
	    $('#geocode-results').on("click", ".geocode-result", function() {
	    	var index = $(this).val();
	    	mymap.setCenter(geocodeResults[index].geometry.location);
    		mymap.setZoom(15);
    		mymarker = new google.maps.Marker({ map: mymap });
    		mymarker.setPosition(geocodeResults[index].geometry.location);
	    })
	    $('#button-lookup-address').click(function() {
	    	var geocoderRequest = {
                address: $('#lookup-address').val()
            }
	    	geocoder.geocode(geocoderRequest, function(results, status) {
	    		if (results.length > 0) {
	    			geocodeResults = results.slice(0,10);
	    			$('#geocode-results').html('');
	    			for (var i=0; i<geocodeResults.length; i++) {
	    				$('#geocode-results').append(
	    					'<input class="geocode-result" type="radio" value="' + i + '" ' +  
	    					(i==0 ? 'checked="checked" ' : '') + 
	    					'name="geocode-results" /> ' +
    						geocodeResults[i].formatted_address + "<br />"
   						);
	    			}	    			
		    		mymap.setCenter(results[0].geometry.location);
		    		mymap.setZoom(15);
		    		mymarker = new google.maps.Marker({ map: mymap });
		    		mymarker.setPosition(results[0].geometry.location);
		    		$('#geocode-results-container').show();
	    		} else {
	    			alert('No results found for that address.');
	    		}
	    	});
	    });
	    $('#button-use-address').click(function() {
	    	var index = $('input[name=geocode-results]:checked').val();
	    	var add = geocodeResults[index];
	    	$('form[name=address-form] input[name=full_address]').val(add.formatted_address);
	    	$('form[name=address-form] input[name=street]').val('');
	    	$('form[name=address-form] input[name=city]').val('');
	    	$('form[name=address-form] input[name=neighborhood]').val('');
	    	var lat = parseFloat(add.geometry.location.lat()).toFixed(7);
	    	var lng = parseFloat(add.geometry.location.lng()).toFixed(7)
	    	$('form[name=address-form] input[name=latitude]').val(lat);
	    	$('form[name=address-form] input[name=longitude]').val(lng);
	    	for (var i=0; i<add.address_components.length; i++) {
		    	if ($.inArray("route", add.address_components[i].types) != -1) {
		    		$('form[name=address-form] input[name=street]').val(add.address_components[i].short_name);
	            } 
		    	if ($.inArray("neighborhood", add.address_components[i].types) != -1) {
	                $('form[name=address-form] input[name=neighborhood]').val(add.address_components[i].short_name);
	            }
	            if ($.inArray("locality", add.address_components[i].types) != -1) {
	                $('form[name=address-form] input[name=city]').val(add.address_components[i].long_name);
	            }
	    	}
	    	$("form[name=address-form]").submit();
	    });
	}); 
    
</script>

	<h2>Account Settings for {{ current.user.get_full_name }}</h2>
	<hr>
	<div class="row">
	    <div class="col-md-4">
		    <div class="list-group">
		        <div class="list-group-item" id="email-view" {% if showEditView == 'userEmailForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="email-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Email</dt>
			            <dd>{{ userEmailDisplay.email.value }}</dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="email-edit" {% if showEditView != 'userEmailForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="email-close-btn">Close</a>
			        <form action="{{ callback }}" method="post">
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="userEmailForm" />
				        {% for field in userEmailForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
				        <input type="submit" class="btn btn-primary" value="Save Changes" />
				    </form>
			    </div>
			    <div class="list-group-item" id="password-view" {% if showEditView == 'userPasswordForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="password-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Password</dt>
			            <dd>********</dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="password-edit" {% if showEditView != 'userPasswordForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="password-close-btn">Close</a>
			        <form action="{{ callback }}" method="post">
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="userPasswordForm" />
				        {% for field in userPasswordForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
				        <input type="submit" class="btn btn-primary" value="Save Changes" />
				    </form>
			    </div>
			    <div class="list-group-item" id="name-view" {% if showEditView == 'userNameForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="name-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Name</dt>
			            <dd>{{ userNameDisplay.first_name.value }} {{ userNameDisplay.last_name.value }}</dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="name-edit" {% if showEditView != 'userNameForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="name-close-btn">Close</a>
			        <form action="{{ callback }}" method="post">
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="userNameForm" />
				        {% for field in userNameForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
				        <input type="submit" class="btn btn-primary" value="Save Changes" />
				    </form>
			    </div>
			    <div class="list-group-item" id="privacy-view" {% if showEditView == 'memberPrivacyForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="privacy-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Privacy</dt>
			            <dd>
			                {% if memberPrivacyDisplay.share_email.value %}
			                    sharing email with friends<br>
			                {% endif %}
			                {% if memberPrivacyDisplay.share_address.value %}
			                    sharing address with friends<br>
			                {% endif %}
			                {% if memberPrivacyDisplay.share_phone.value %}
			                    sharing phone number with friends<br>
			                {% endif %}
			            </dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="privacy-edit" {% if showEditView != 'memberPrivacyForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="privacy-close-btn">Close</a>
			        <form action="{{ callback }}" method="post">
			        	<label>Privacy Settings:</label>
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="memberPrivacyForm" />
				        {% for field in memberPrivacyForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
			        	<input type="submit" class="btn btn-primary" value="Save Changes" />
			        </form>
			    </div>
			    <div class="list-group-item" id="phone-view" {% if showEditView == 'memberPhoneForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="phone-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Phone</dt>
			            <dd>{{ memberPhoneDisplay.phone_number.value }} ({{ memberPhoneDisplay.phone_type.value }})</dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="phone-edit" {% if showEditView != 'memberPhoneForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="phone-close-btn">Close</a>
			        <form action="{{ callback }}" method="post">
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="memberPhoneForm" />
				        {% for field in memberPhoneForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
				        <input type="submit" class="btn btn-primary" value="Save Changes" />
				    </form>
			    </div>
			    <div class="list-group-item" id="full-address-view">
			        <a href="#" class="badge" id="full-address-edit-btn" data-toggle="modal" data-target="#full-address-modal">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Address</dt>
			            <dd>
			                {{ addressForm.full_address.value }}
	                    </dd>
			        </dl> 
			        <div style="display:none;">
			        	<form action="{{ callback }}" method="post" name="address-form">
				            {% csrf_token %}
				            <input type="hidden" name="form-name" value="addressForm" />
					        {% for field in addressForm %}
						        {% include 'blocks/formgroup.html' %}
					        {% endfor %}
					        <input type="submit" class="btn btn-primary" value="Save Changes" />
					    </form>
			        </div>    
			    </div>
			    <div class="list-group-item" id="display-address-view" {% if showEditView == 'memberDisplayAddressForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="display-address-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Display Address</dt>
			            <dd>
			            	{% if memberDisplayAddressForm.neighborhood.value %}
			            	    {{ memberDisplayAddressForm.street.value }} ({{ memberDisplayAddressForm.neighborhood.value }})
			            	{% else %}
			            		{{ memberDisplayAddressForm.street.value }} ({{ memberDisplayAddressForm.city.value }})
			            	{% endif %}
			            </dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="display-address-edit" {% if showEditView != 'memberDisplayAddressForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="display-address-close-btn">Close</a>
					<div class="alert alert-warning">
					  <p>If you've moved please change your <a href="#" data-toggle="modal" data-target="#full-address-modal">full address</a>
			           first so we will know where you are.</p>
					</div>
			        <form action="{{ callback }}" method="post">
			            {% csrf_token %}
			            <input type="hidden" name="form-name" value="memberDisplayAddressForm" />
				        {% for field in memberDisplayAddressForm %}
					        {% include 'blocks/formgroup.html' %}
				        {% endfor %}
				        <input type="submit" class="btn btn-primary" value="Save Changes" />
				    </form>
			    </div>
			    <div class="list-group-item" id="account-status-view" {% if showEditView == 'accountStatusForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="account-status-edit-btn">Edit</a>
			        <dl class="dl dl-3">
			            <dt>Account Status</dt>
			            <dd>
			            	Active
			            </dd>
			        </dl>     
			    </div>
			    <div class="list-group-item" id="account-status-edit" {% if showEditView != 'accountStatusForm' %}style="display:none;"{% endif %}>
			        <a href="#" class="badge" id="account-status-close-btn">Close</a>
			            <label>Account Actions:</label><br>
				        <button type="button" class="btn btn-danger" data-toggle="modal" data-target="#delete-account-modal">
				            Permanently Delete Account
				        </button>
			    </div>
			</div>
		</div>
		<div class="col-md-4 col-md-offset-2">
		    <div class="list-group">
				<div class="list-group-item" id="user-pic-view">
			        <a href="#" class="badge" id="user-pic-edit-btn" data-toggle="modal" data-target="#upload-pic-modal">Edit</a>
			        <dl class="dl dl-3">
			            <dt>User Pic</dt>
			            <dd>
			                <img class="current-user-pic" src="{{ current.member.get_user_pic }}" alt="my alt" width="150" height="150"
			                    data-toggle="modal" data-target="#upload-pic-modal">
	                    </dd>
			        </dl>     
			    </div>
		    </div>
		</div>
	</div>


<form action="{{ callback }}" method="post">
	<div class="modal" id="delete-account-modal">
	  <div class="modal-dialog modal-sm">
	    <div class="modal-content">
	      <div class="modal-header">
	        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
	        <h4 class="modal-title">Delete Account</h4>
	      </div>
	      <div class="modal-body">
	          
	            {% csrf_token %}
	            This will <strong class="text-danger">permanently</strong> delete your account and all items associated with your account.
	            Are you sure you want to continue?
	            <input type="hidden" name="form-name" value="deleteAccountForm" />
	      </div>
	      <div class="modal-footer">
	        <input type="submit" class="btn btn-danger" value="Delete Account" />
	        <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
	      </div>
	    </div>
	  </div>
	</div>
</form>

<div class="modal" id="full-address-modal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">X</button>
        <h4 class="modal-title">Set Address</h4>
      </div>
      <div class="modal-body">
          {% include "blocks/map.html" %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>








	
<script type="text/javascript">
	$(document).ready(function(){
		var api  // Jcrop api
	    var $progressBar = $('#progressBar')
	    //options
	    var options = {
	        fileInputs: ['#file'],
	        canvases: {
	            medium: {
	                'object': '#medium'
	            }
			},
	        dragDrops: ['#dragDrop'],
	        afterPick: function () {
	            this.setSelect([0, 0, 400, 300])  // initial selection
	        },
	        beforePick: function (img) {
	            if (img) {//valid file
	                if (img.width < 300 || img.height < 300) {
	                    alert('The image width and height must be over or equal to 300!')
	                    return true  // ignore this img
	                }
	            }
	            else {// invalid file
	                alert('Invalid file!')
	            }
	        },
	        aspectRatio: 1 / 1,
	        minSize: [150, 150],
	        boxWidth: 400,
	        boxHeight: 400
	    }
	    $('#image').Jcrop(options, function () {
	        api = this;
	        this.setSelect([50, 38, 300, 225]);
	        //api.drawInCanvas($('#medium')[0])
	    })
	    
   
	    $('#upload').click(function() {
	        if (!api) {
	            return
	        }
	        if (!api.isSelected()) {
	            alert('No selection!')
	            return
	        }
	        $progressBar.find('div').width(0)
	        //sources
	        var sources = [
	            {
	                key: 'medium', // key in options.canvases
	                format: 'image/png' // default = 'image/jpeg'
	            }
	        ]
	        //settings
	        var settings = {
	            url: '/account/upload_image/',
	            data: {'member_id': '{{ current.member.id }}'}, //three fields (medium, small, text) to upload
	            onprogress: function (evt) { // function for xhr.upload.onprogress
	                if (evt.lengthComputable) {
	                    progress(evt.loaded / evt.total, $progressBar)
	                }
	            },
	            success: function (data) {
	            	console.log(data)
	            	$('#id_user_pic_medium').val(data.file);
	            	$(".current-user-pic").attr("src", data.path);
	            	$("#shared-user-pic").attr("src", data.path);
	            },
	            error: function ( jqXHR, textStatus, errorThrown ) {
	                alert(errorThrown + ' ' + textStatus)
	            }
	        }
	        api.upload(sources, settings)
	    });


	    function progress(percent, $element) {
	        var progressBarWidth = percent * $element.width();
	        $element.find('div').animate({ width: progressBarWidth }, 50).html(Math.round(percent * 100) + "%&nbsp;");
	    }
	    
	    
	    

	    

	    
	});
</script>

{% include "blocks/upload-tool.html" %}
	
{% endblock %}	